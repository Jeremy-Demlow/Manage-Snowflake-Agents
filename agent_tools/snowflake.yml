definition_version: 2

env:
  database: "SKI_RESORT_DB"
  schema: "MODELS"
  warehouse: "COMPUTE_WH"
  stage: "AGENT_TOOLS_STAGE"

entities:
  # ==========================================================================
  # AGENT CALLER UDF - Calls Cortex Agent via PAT-authenticated REST API
  # ==========================================================================
  ask_resort_executive:
    type: "function"
    identifier:
      name: "ask_resort_executive"
      database: "SKI_RESORT_DB"
      schema: "MODELS"
    handler: "scheduled_alerts.agent_caller.run_agent"
    signature:
      - name: "user_query"
        type: "TEXT"
    returns: "TEXT"
    stage: "SKI_RESORT_DB.MODELS.AGENT_TOOLS_STAGE"
    artifacts: ["src/"]
    runtime: "3.11"
    external_access_integrations: ["CORTEX_AGENT_ACCESS_INTEGRATION"]
    secrets:
      agent_token: "SKI_RESORT_DB.MODELS.CORTEX_AGENT_PAT_SECRET"
    artifact_repository: snowflake.snowpark.pypi_shared_repository
    packages:
      - snowflake-snowpark-python
      - requests

  # ==========================================================================
  # EMAIL FORMATTER UDF - Converts markdown to styled HTML for emails
  # ==========================================================================
  format_alert_email:
    type: "function"
    identifier:
      name: "format_alert_email"
      database: "SKI_RESORT_DB"
      schema: "MODELS"
    handler: "scheduled_alerts.email_formatter.format_email"
    signature:
      - name: "question"
        type: "TEXT"
      - name: "response"
        type: "TEXT"
    returns: "TEXT"
    stage: "SKI_RESORT_DB.MODELS.AGENT_TOOLS_STAGE"
    artifacts: ["src/"]
    runtime: "3.11"
    artifact_repository: snowflake.snowpark.pypi_shared_repository
    packages:
      - markdown
      - premailer

  # ==========================================================================
  # SCHEDULED ALERTS PROCESSOR - Main procedure for daily alert processing
  # ==========================================================================
  process_alerts:
    type: "procedure"
    identifier:
      name: "process_scheduled_alerts"
      database: "SKI_RESORT_DB"
      schema: "MODELS"
    handler: "scheduled_alerts.alerts_processor.process_alerts"
    signature: []
    returns: "TEXT"
    stage: "SKI_RESORT_DB.MODELS.AGENT_TOOLS_STAGE"
    artifacts: ["src/"]
    runtime: "3.11"
    artifact_repository: snowflake.snowpark.pypi_shared_repository
    packages:
      - snowflake-snowpark-python

  # ==========================================================================
  # ML OBSERVABILITY - Backfill actuals for model monitoring
  # ==========================================================================
  backfill_prediction_actuals:
    type: "procedure"
    identifier:
      name: "backfill_prediction_actuals"
      database: "SKI_RESORT_DB"
      schema: "MODELS"
    handler: "forecasting_tools.monitoring.monitor.backfill_actuals"
    signature: []
    returns: "TEXT"
    stage: "SKI_RESORT_DB.MODELS.AGENT_TOOLS_STAGE"
    artifacts: ["src/"]
    runtime: "3.11"
    artifact_repository: snowflake.snowpark.pypi_shared_repository
    packages:
      - snowflake-snowpark-python

  # ==========================================================================
  # LEGACY TOOLS (kept for backwards compatibility)
  # ==========================================================================

  # Email Tool
  send_mail:
    type: "procedure"
    identifier:
      name: "send_mail"
      database: "AGENT_TOOLS_CENTRAL"
      schema: "AGENT_TOOLS"
    handler: "email_tools.sender.send_email_for_agent"
    signature:
      - name: "recipient"
        type: "TEXT"
      - name: "subject"
        type: "TEXT"
      - name: "text"
        type: "TEXT"
    returns: "TEXT"
    stage: "AGENT_TOOLS_CENTRAL.AGENT_TOOLS.AGENT_TOOLS_STAGE"
    artifacts: ["src/"]
    runtime: "3.10"
    artifact_repository: snowflake.snowpark.pypi_shared_repository
    packages:
      - snowflake-snowpark-python

  # Web Scraper Tool
  web_scrape:
    type: "procedure"
    identifier:
      name: "web_scrape"
      database: "AGENT_TOOLS_CENTRAL"
      schema: "AGENT_TOOLS"
    handler: "web_tools.scraper.scrape_website_for_agent"
    signature:
      - name: "url"
        type: "TEXT"
    returns: "TEXT"
    stage: "AGENT_TOOLS_CENTRAL.AGENT_TOOLS.AGENT_TOOLS_STAGE"
    artifacts: ["src/"]
    runtime: "3.10"
    external_access_integrations: ["AGENT_TOOLS_EXTERNAL_ACCESS_INTEGRATION"]
    artifact_repository: snowflake.snowpark.pypi_shared_repository
    packages:
      - snowflake-snowpark-python
      - requests
      - beautifulsoup4

  # ==========================================================================
  # ML FORECASTING (requires Snowpark-optimized warehouse)
  # Deploy with: snow snowpark deploy --warehouse SNOWPARK_WH
  # ==========================================================================
  forecast_visitors_ml:
    type: "procedure"
    identifier:
      name: "forecast_visitors_ml"
      database: "SKI_RESORT_DB"
      schema: "MARTS"
    handler: "forecasting_tools.forecast_handler.forecast_visitors"
    signature:
      - name: "forecast_start_date"
        type: "DATE"
      - name: "days_ahead"
        type: "NUMBER"
        default: 7
    returns: "TEXT"
    stage: "SKI_RESORT_DB.MARTS.AGENT_TOOLS_STAGE"
    artifacts: ["src/"]
    runtime: "3.11"
    artifact_repository: snowflake.snowpark.pypi_shared_repository
    packages:
      - snowflake-snowpark-python
      - snowflake-ml-python
      - xgboost
      - pyyaml
      - pandas
      - numpy
    resource_constraint:
      architecture: "x86"
